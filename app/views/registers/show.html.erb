<% unless @student_groups.blank? %>
<% content_for :bottom do %>
  <%= javascript_include_tag "register" %>
<% end %>
<% form_tag :action => "show" do %>
  <% javascript_tag do %>
    Ext.onReady(function() {
      Global.group_store = <%= extjs_simple_store({ :data => student_group_collection(@student_groups), :type => :arrays, :fields => ["id", "name", "year"] }) %>;
      Global.subject_store = <%= extjs_simple_store({ :data => subject_collection(@subjects), :type => :arrays, :fields => ["id", "name"] }) %>;
      
      Global.mark_values = <%= RegistersController::MARK_VALUES.collect { |v| [v] }.to_json %>
        Global.mark_value_store = new Ext.data.SimpleStore({
        fields: [{name: "mark"}]
      });
      Global.mark_value_store.loadData(Global.mark_values);
      
      Global.marks = <%= mark_collection(@students, @dates, @mark_table).to_json %>;  
      Global.dates = <%= date_collection(@dates).to_json %>;
      Global.students = <%= student_collection(@students).to_json %>;
      
      var panel = new Ext.Panel({
        renderTo: "panel_container",
        width: 825,
        title: "Журнал",
        tbar: [{
          xtype: 'combo',
          store: Global.group_store,
          displayField: 'name',
          valueField: 'id',
          value: <%= @current_group_id %>,
          triggerAction: 'all',
          mode: 'local',
          forceSelection: true,
          editable: false,
          listeners: {
            select: function(combo, record, index) {
              $('current_group').value = record.get("id");
              Global.submitForm(combo.getId());
            }
          }
        },
        '-',
        {
          xtype: 'combo',
          store: Global.subject_store,
          displayField: 'name',
          valueField: 'id',
          value: <%= @current_subject_id %>,
          triggerAction: 'all',
          mode: 'local',
          forceSelection: true,
          editable: false,
          listeners: {
            select: function(combo, record, index) {
              $('current_subject').value = record.get("id");
              Global.submitForm(combo.getId());
            }
          }
        }  
        ]
      });
    });
  <% end %>  
  
  <div id="markBoxContainer" class="x-hide-display">
    <%= extjs_combo_box_control "", "", :id => "markBox", :width => 40, :store => "Global.mark_value_store", :displayField => "mark", :valueField => "mark" %>
  </div>
  <%= hidden_field_tag "current_group", @current_group_id, :id => "current_group" %>
  <%= hidden_field_tag "current_subject", @current_subject_id, :id => "current_subject" %>

  <div class="clear"></div>
  <div id="panel_container" class="register-panel-container"></div>
  <div id="toolbar"></div>
  <div id="register_container"></div>
  
  <% javascript_tag do %>
    Ext.onReady(function() {
      Global.register = new Register({ 
        renderTo: "register_container",
        marks: Global.marks,
        dates: Global.dates,
        students: Global.students,
        readonly: <%= @read_only %>,
        markBox: Ext.getCmp("markBox")
      });
            
      Global.register.markBox.on("select", function(box, record) {
        Global.register.chooseMark(Global.register.editCell, record.get("mark"), function(i, j, studentId, date, itemId, mark, callback) {
          Ext.Ajax.request({
            url: '<%= mark_register_path %>',
            params: { i: i, j: j, mark: mark, student_id: studentId, date: date, item_id: itemId },
            success: function(response) {
              callback(response.responseText);
            }
          });
        });
      });
      Global.register.markBox.on("expand", function() {
        Global.register.clearListeners();
      });
      Global.register.markBox.on("collapse", function() {
        Global.register.setListeners();
      });
      

    });
    
  <% end %>
<% end %>
<% else %>
  Вы не можете просмотреть ни один журнал.
<% end %>